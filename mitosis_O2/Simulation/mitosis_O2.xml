<CompuCell3D>

  <Potts>
    <Dimensions x="100" y="100" z="100"/>
    <Steps>10000</Steps>
    <Temperature>50</Temperature>  <!-- INCREASED for more active behavior -->
    <NeighborOrder>3</NeighborOrder>  <!-- INCREASED for smoother spherical surfaces -->
    <Boundary_x>Periodic</Boundary_x> <!-- Add periodic boundaries for more dynamic behavior -->
    <Boundary_y>Periodic</Boundary_y>
    <Boundary_z>Periodic</Boundary_z>
  </Potts>

  <Plugin Name="CellType">
    <CellType TypeName="Medium"   TypeId="0"/>
    <CellType TypeName="Normoxic" TypeId="1"/>
    <CellType TypeName="Hypoxic"  TypeId="2"/>
    <CellType TypeName="Necrotic" TypeId="3"/>
  </Plugin>

  <Plugin Name="Volume">
    <!-- Stronger volume constraints for spherical shape maintenance -->
    <VolumeEnergyParameters CellType="Normoxic" LambdaVolume="10.0" TargetVolume="35"/>
    <VolumeEnergyParameters CellType="Hypoxic"  LambdaVolume="10.0" TargetVolume="30"/>
    <VolumeEnergyParameters CellType="Necrotic" LambdaVolume="1000.0" TargetVolume="25"/>
  </Plugin>

  <Plugin Name="Surface">
    <!-- STRONG surface constraints for highly spherical cells.
      For perfect spheres: S = (36*π)^(1/3) * V^(2/3) ≈ 4.836 * V^(2/3)
      V=35 → S=51.8, V=30 → S=45.6, V=25 → S=39.1
      Very high LambdaSurface values force spherical shapes -->
    <SurfaceEnergyParameters CellType="Normoxic" LambdaSurface="15.0" TargetSurface="52"/>
    <SurfaceEnergyParameters CellType="Hypoxic"  LambdaSurface="15.0" TargetSurface="46"/>
    <SurfaceEnergyParameters CellType="Necrotic" LambdaSurface="1000.0" TargetSurface="39"/>
  </Plugin>

  <Plugin Name="Contact">

    <Energy Type1="Medium"   Type2="Medium">0</Energy>

    <Energy Type1="Medium"   Type2="Normoxic">2</Energy>
    <Energy Type1="Medium"   Type2="Hypoxic">2</Energy>
    <Energy Type1="Medium"   Type2="Necrotic">2</Energy>

    <Energy Type1="Normoxic" Type2="Normoxic">1</Energy>
    <Energy Type1="Hypoxic"  Type2="Hypoxic">1</Energy>
    <Energy Type1="Necrotic" Type2="Necrotic">1</Energy>

    <Energy Type1="Normoxic" Type2="Hypoxic">5</Energy>
    <Energy Type1="Normoxic" Type2="Necrotic">5</Energy>
    <Energy Type1="Hypoxic"  Type2="Necrotic">5</Energy>
  </Plugin>

  <Plugin Name="NeighborTracker"/>
  <Plugin Name="CenterOfMass"/>
  <Plugin Name="PixelTracker"/>

  <!-- Force continuous activity to prevent early stopping -->
  <Plugin Name="Chemotaxis">
    <ChemicalField Name="Oxygen" Source="DiffusionSolverFE">
      <!-- Only living cells can move - necrotic cells excluded -->
      <ChemotaxisByType Type="Normoxic" Lambda="10.0"/>
      <ChemotaxisByType Type="Hypoxic" Lambda="15.0"/>
      <!-- NO chemotaxis for necrotic cells - they're frozen -->
    </ChemicalField>
  </Plugin>

  <!-- Improved oxygen diffusion system for spheroid formation -->
  <Steppable Type="DiffusionSolverFE">
    <DiffusionField Name="Oxygen">
      <DiffusionData>
        <FieldName>Oxygen</FieldName>
        <!-- Realistic oxygen diffusion in tissue-like medium -->
        <DiffusionConstant>0.1</DiffusionConstant>
        <!-- No bulk decay - oxygen only consumed by cells -->
        <DecayConstant>0.0</DecayConstant>
        <!-- UNIFORM oxygen throughout entire domain at t=0 -->
        <InitialConcentration>1.0</InitialConcentration>
      </DiffusionData>

      <SecretionData>
        <!-- MUCH REDUCED oxygen consumption for better proliferation -->
        <Uptake Type="Normoxic" MaxUptake="0.05" RelativeUptakeRate="0.02"/>
        <Uptake Type="Hypoxic"  MaxUptake="0.03" RelativeUptakeRate="0.015"/>
        <Uptake Type="Necrotic" MaxUptake="0.01" RelativeUptakeRate="0.005"/>
      </SecretionData>

      <BoundaryConditions>
        <!-- Oxygen supply from boundaries (simulates vasculature) -->
        <Plane Axis="X">
          <ConstantValue PlanePosition="Min" Value="1.0"/>
          <ConstantValue PlanePosition="Max" Value="1.0"/>
        </Plane>
        <Plane Axis="Y">
          <ConstantValue PlanePosition="Min" Value="1.0"/>
          <ConstantValue PlanePosition="Max" Value="1.0"/>
        </Plane>
        <Plane Axis="Z">
          <ConstantValue PlanePosition="Min" Value="1.0"/>
          <ConstantValue PlanePosition="Max" Value="1.0"/>
        </Plane>
      </BoundaryConditions>

    </DiffusionField>
  </Steppable>

  <!-- Centralized user-defined parameters controlling behavior of Python steppables.
    All numerical model parameters used in steppables are defined here so that
    the XML is the single source of truth. -->
  <UserParameters>
    <Param Name="InitRadius" Value="2" Desc="Seed cell spherical radius (voxels)"/>
    <Param Name="SeedTargetVolume" Value="35" Desc="Initial seed cell target volume"/>
    <Param Name="SeedLambdaVolume" Value="10.0" Desc="Volume constraint strength for seed (INCREASED for sphericity)"/>
    <Param Name="SeedLambdaSurface" Value="15.0" Desc="Surface constraint strength for seed (INCREASED for sphericity)"/>
    <Param Name="EarliestDivisionMCS" Value="50" Desc="Minimum MCS before any division allowed"/>
    <Param Name="TV_Min" Value="15.0" Desc="Minimum living cell target volume clamp"/>
    <Param Name="TV_Max" Value="80.0" Desc="Maximum living cell target volume clamp"/>
    <Param Name="GrowthRateNormoxic" Value="15.0" Desc="Base growth increment per MCS (normoxic)"/>
    <Param Name="GrowthRateHypoxic" Value="1.0" Desc="Base growth increment per MCS (hypoxic)"/>
    <Param Name="GrowthBoostNormoxic" Value="2.0" Desc="Multiplicative boost for normoxic growth"/>
    <Param Name="GrowthBoostHypoxic" Value="2.0" Desc="Multiplicative boost for hypoxic growth"/>
    <Param Name="ForcedGrowthIncrement" Value="1.0" Desc="Additional forced growth each MCS (living cells)"/>
    <Param Name="PostDivisionGrowthFactor" Value="0.3" Desc="Post-division global growth factor per MCS"/>
    <Param Name="HypoxicVolumeReduceFactor" Value="0.95" Desc="Factor to reduce target volume on hypoxic transition"/>
    <Param Name="O2_Thresh_Normoxic" Value="0.90" Desc="O2 above which hypoxic reverts to normoxic"/>
    <Param Name="O2_Thresh_Hypoxic" Value="0.08" Desc="O2 below which normoxic becomes hypoxic"/>
    <Param Name="O2_Thresh_Necrotic" Value="0.03" Desc="O2 below which cell becomes necrotic"/>
    <Param Name="O2_Reset_Threshold" Value="0.5" Desc="Early MCS oxygen reset if center below this"/>
    <Param Name="DivisionVolume" Value="25.0" Desc="Volume threshold to consider division"/>
    <Param Name="DivProbHighO2" Value="0.99" Desc="Division probability at high O2"/>
    <Param Name="DivProbMedO2" Value="0.75" Desc="Division probability at medium O2 range"/>
    <Param Name="DivProbLowO2" Value="0.05" Desc="Division probability for hypoxic cells"/>
    <Param Name="DivO2High" Value="0.30" Desc="O2 cutoff for high division probability"/>
    <Param Name="DivO2Med" Value="0.15" Desc="O2 cutoff for medium division probability"/>
    <Param Name="DivO2Lower" Value="0.10" Desc="O2 cutoff for slightly reduced medium probability"/>
    <Param Name="DivO2LowEdge" Value="0.08" Desc="Lowest O2 for medium probability scaling"/>
    <Param Name="DivHypoxicMin" Value="0.07" Desc="Minimum O2 for hypoxic division consideration"/>
    <Param Name="NecroticFreezeLambda" Value="50.0" Desc="Lambda values to freeze necrotic cells"/>
    <Param Name="NecroticShrinkageRate" Value="0.5" Desc="Volume reduction rate per MCS for necrotic cells"/>
    <Param Name="NecroticMinVolume" Value="5.0" Desc="Minimum volume before necrotic cell removal"/>
    <Param Name="NecroticLifetime" Value="75" Desc="Maximum MCS a necrotic cell exists before removal"/>
    <Param Name="OutputFrequency" Value="50" Desc="Global analysis/log print frequency (MCS)"/>
    <Param Name="ActivityFrequency" Value="10" Desc="Frequency for activity forcer steppable"/>
    <Param Name="AnalysisRadius1" Value="10" Desc="Inner oxygen sample radius (voxels)"/>
    <Param Name="AnalysisRadius2" Value="20" Desc="Outer oxygen sample radius (voxels)"/>
  <Param Name="DivHypoxicScale" Value="0.4" Desc="Scale factor for hypoxic division probability"/>
  <Param Name="DivMedScale1" Value="0.9" Desc="Medium O2 division probability scale 1"/>
  <Param Name="DivMedScale2" Value="0.8" Desc="Medium-low O2 division probability scale 2"/>
  <Param Name="HypoxicMaxVolumeFrac" Value="0.8" Desc="Fraction of TV_Max allowed for hypoxic growth"/>
    <Param Name="ActivityPerturbation" Value="0.1" Desc="Amplitude of random volume perturbation"/>
    <Param Name="ActivityStableDeltaThreshold" Value="2" Desc="Cell count delta threshold triggering perturbation"/>
    <Param Name="EarlyO2CheckWindowFactor" Value="0.2" Desc="Fraction of OutputFrequency defining early O2 reset window"/>
  </UserParameters></CompuCell3D>